<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.xmh.web.blogserver.mapper.ArticleMapper">

    <cache eviction="FIFO" flushInterval="60000" size="512" readOnly="true"/>

    <sql id="selectAll">
        SELECT a.*,c.cate_name,tp.type_name from article a
        LEFT JOIN category c on a.cate_id=c.cate_id
        LEFT JOIN types tp ON tp.type_id=a.type_id
    </sql>

    <insert id="insertArticle" keyColumn="article_id" keyProperty="articleId" useGeneratedKeys="true">
        insert into article (title, md_content, html_content, summary, type_id, cate_id, user_id, publish_time,
        update_time, recommend, article_state, views, likes, comments, first_picture)
        values (#{title},#{mdContent},#{htmlContent},#{summary},#{typeId},#{cateId},#{userId},#{publishTime},#{updateTime}
        ,#{recommend},#{articleState},#{views},#{likes},#{comments},#{firstPicture})
    </insert>

    <update id="updateByArticleId">
        update article set title=#{title}, md_content=#{mdContent}, html_content=#{htmlContent}, summary=#{summary},
        type_id=#{typeId}, cate_id=#{cateId},update_time=#{updateTime},recommend=#{recommend},
        article_state=#{articleState}, views=#{views}, likes=#{likes}, comments=#{comments}, first_picture=#{firstPicture})
        where article_id=#{article_id}
    </update>

    <update id="resetArticleState">
        update article set article_state=#{article_state} where article_id=#{article_id}
    </update>

    <delete id="deleteByArticleId">
        delete from article where article_id=#{article_id}
    </delete>

    <select id="getLikeTitleArticle" resultType="cn.xmh.web.blogserver.model.Article">
        <include refid="selectAll"></include>
        where title like concat('%',#{title},'%')
    </select>

    <select id="getNewRecommend" resultType="java.util.Map">
        SELECT article_id,title FROM article WHERE recommend=1 ORDER BY publish_time DESC LIMIT 5
    </select>

    <select id="getNewTitle" resultType="java.util.Map">
        SELECT article_id,title FROM article ORDER BY publish_time DESC LIMIT 4
    </select>

    <select id="getTypeArticle" resultType="cn.xmh.web.blogserver.model.Article">
        <include refid="selectAll"></include>
        where type_name=#{type_name}
    </select>

    <select id="getArticleByTagId" resultType="cn.xmh.web.blogserver.model.Article">
        <include refid="selectAll"></include>
        LEFT JOIN article_tags t ON a.article_id=t.article_id
        WHERE tag_id=#{tag_id}
    </select>

    <select id="getArticleByCateName" resultType="cn.xmh.web.blogserver.model.Article">
        <include refid="selectAll"></include>
        WHERE c.cate_name=#{cate_name}
    </select>

    <select id="getYearsCountArticle" resultType="java.util.Map">
        SELECT YEAR(publish_time) years,COUNT(article_id) counts FROM article GROUP BY years ORDER BY years DESC
    </select>

    <select id="getMonthsByYear" resultType="java.util.Map">
        SELECT COUNT(article_id) monthCount, month(publish_time) months FROM article
        WHERE YEAR(publish_time)=#{year} GROUP BY month(publish_time)
    </select>

    <select id="getInfoByMonthYear" resultType="java.util.Map">
        SELECT article_id,title,publish_time FROM article
        WHERE MONTH(publish_time)=#{month} AND YEAR(publish_time)=#{year}
    </select>

    <select id="getTotalData" resultType="java.util.Map">
        SELECT SUM(views) 'views',SUM(likes) 'likes',SUM(comments) 'comments' ,COUNT(article_id) 'articles' FROM article
    </select>

    <select id="getArticleById" resultType="cn.xmh.web.blogserver.model.Article">
        select * from article where article_id=#{article_id}
    </select>

    <select id="getArticleByDelete" resultType="cn.xmh.web.blogserver.model.Article">
        <include refid="selectAll"></include>
        where article_state = -1
    </select>

    <select id="getArticleByNotDelete" resultType="cn.xmh.web.blogserver.model.Article">
        <include refid="selectAll"></include>
        where article_state != -1
    </select>

    <select id="getArticleNum" resultType="java.lang.Integer">
        select COUNT(article_id) from article
    </select>

    <select id="getAllPage" resultType="cn.xmh.web.blogserver.model.Article">
        <include refid="selectAll"></include>
    </select>

</mapper>